<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>精美聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }
    .app-container { display: flex; height: 100vh; }
    .sidebar {
      width: 280px; background: #f8f9fa; border-right: 1px solid #dee2e6;
      display: flex; flex-direction: column;
    }
    .sidebar h5 { padding: 1rem; margin: 0; border-bottom: 1px solid #dee2e6; }
    .sidebar .friend-list { flex: 1; overflow-y: auto; padding: 0.5rem 1rem; }
    .sidebar .friend {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem;
      border-radius: 0.5rem; cursor: pointer; transition: background 0.2s;
    }
    .sidebar .friend:hover { background: #e9ecef; }
    .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
    .chat-header { padding: 1rem; border-bottom: 1px solid #dee2e6; background: #fff; font-weight: bold; }
    .chat-messages {
      flex: 1; padding: 1rem; overflow-y: auto; background: #f1f3f5;
      display: flex; flex-direction: column; gap: 1rem;
    }
    .message {
      max-width: 70%; background: white; padding: 0.75rem 1rem;
      border-radius: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      position: relative;
    }
    .message.self { align-self: flex-end; background: #d0ebff; }
    .message img.content-image { max-width: 100%; border-radius: .5rem; margin-top: .5rem; }
    .message .time { font-size: 0.75em; color: gray; position: absolute; bottom: -1.2rem; right: .5rem; }
    .message .read-indicator { font-size: 0.75em; color: green; margin-top: .25rem; }
    .chat-input { padding: 1rem; border-top: 1px solid #dee2e6; background: #fff; }
    #top-controls {
      position: absolute; top: 1rem; right: 1rem;
      display: flex; gap: 0.75rem;
    }
    #userMenu, #notifMenu {
      position: absolute; top: 3.5rem; right: 1rem;
      background: white; border: 1px solid #ccc;
      border-radius: 6px; padding: 0.75rem 1rem;
      display: none; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
      z-index: 100;
    }
    #addFriendSection, #createGroupSection { display: none; padding: 0 1rem 1rem 1rem; }
    .status-wrapper { position: relative; }
    .status-dot {
      position: absolute; bottom: 0; right: 0;
      width: 10px; height: 10px; border-radius: 50%;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="sidebar">
      <h5>聊天清單</h5>
      <div class="friend-list" id="friend-list"></div>
      <div class="p-3">
        <button class="btn btn-success w-100 mb-2" onclick="toggleAddFriend()">新增好友</button>
        <div id="addFriendSection">
          <input type="text" id="friendIdInput" class="form-control mb-2" placeholder="輸入用戶ID">
          <button class="btn btn-primary w-100 mb-2" onclick="submitAddFriend()">送出</button>
        </div>
        <button class="btn btn-warning w-100 mb-2" onclick="toggleCreateGroup()">建立群組</button>
        <div id="createGroupSection">
          <input type="text" id="groupNameInput" class="form-control mb-2" placeholder="群組名稱">
          <div id="groupMembersCheckboxes" style="max-height:120px;overflow-y:auto;"></div>
          <button class="btn btn-primary w-100 mb-2" onclick="submitCreateGroup()">建立</button>
        </div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header" id="chat-with">請選擇聊天對象</div>
      <div class="chat-messages" id="message-log"></div>
      <form id="chat-form" class="chat-input d-none">
        <div class="input-group">
          <button class="btn btn-outline-secondary" type="button" onclick="triggerImageUpload()">📷</button>
          <input type="file" id="image-input" accept="image/*" style="display:none" onchange="uploadImage(event)">
          <input type="text" id="message-input" class="form-control" placeholder="輸入訊息...">
          <button class="btn btn-primary" type="submit">傳送</button>
        </div>
      </form>

      <div id="top-controls">
        <button class="btn btn-outline-info btn-sm" onclick="toggleNotifMenu()">🔔</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="toggleUserMenu()">⚙️</button>
        <a href="/auth/logout" class="btn btn-outline-danger btn-sm">登出</a>
      </div>

      <div id="userMenu">
        <div><strong>名稱：</strong><span id="my-name"></span></div>
        <div><strong>用戶ID：</strong><span id="my-code"></span></div>
      </div>
      <div id="notifMenu"></div>
    </div>
  </div>

<script>
var socket = io();
var myId, myNickname, myUserCode, myAvatarUrl;
var chats = [], currentChat = null;

// 切換 UI
function toggleAddFriend(){
  var s = document.getElementById('addFriendSection');
  s.style.display = (s.style.display === 'block') ? 'none' : 'block';
}
function toggleCreateGroup(){
  var s = document.getElementById('createGroupSection');
  if(s.style.display !== 'block'){
    populateGroupMembers();
    s.style.display = 'block';
  } else s.style.display = 'none';
}
function toggleUserMenu(){
  var m = document.getElementById('userMenu');
  m.style.display = (m.style.display === 'block') ? 'none' : 'block';
}
function toggleNotifMenu(){
  var m = document.getElementById('notifMenu');
  m.innerHTML = '';
  m.style.display = 'block';
  fetch('/api/user/friend-requests').then(function(r){ return r.json(); })
  .then(function(reqs){
    if(reqs.length === 0){
      m.innerHTML = '<div class="p-2">沒有好友邀請。</div>';
    }
    reqs.forEach(function(rq){
      var d = document.createElement('div');
      d.className = 'p-2 border-bottom';
      d.innerHTML = '<img src="'+rq.avatarUrl+'" width="30" height="30" class="rounded-circle"> '
        + rq.nickname
        + '<button onclick="respondFriend(\''+rq._id+'\',true)">接受</button>'
        + '<button onclick="respondFriend(\''+rq._id+'\',false)">拒絕</button>';
      m.appendChild(d);
    });
  });
}
function respondFriend(id, ok){
  fetch('/api/user/respond-friend-request',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({requesterId:id,accept:ok})
  }).then(function(){ location.reload(); });
}

// 新增好友
function submitAddFriend(){
  var c = document.getElementById('friendIdInput').value.trim();
  if(!c) return alert('請輸入用戶ID');
  fetch('/api/user/send-friend-request',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({code:c})
  }).then(function(r){
    if(r.ok) alert('邀請已送出');
    else r.json().then(function(d){ alert('❌ '+d.message); });
  });
}

// 建立群組
function populateGroupMembers(){
  fetch('/api/user/me').then(function(r){ return r.json(); })
  .then(function(u){
    var cbx = document.getElementById('groupMembersCheckboxes');
    cbx.innerHTML = '';
    Object.keys(u.friendsMap).forEach(function(id){
      var info = u.friendsMap[id];
      cbx.insertAdjacentHTML('beforeend',
        '<div><input type="checkbox" id="gm_'+id+'" value="'+id+'">'
        +'<label for="gm_'+id+'">'+info.nickname+'</label></div>'
      );
    });
  });
}
function submitCreateGroup(){
  var name = document.getElementById('groupNameInput').value.trim();
  if(!name) return alert('請輸入群組名稱');
  var members = [myId];
  document.querySelectorAll('#groupMembersCheckboxes input:checked').forEach(function(i){
    members.push(i.value);
  });
  fetch('/api/group/create',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name:name,members:members})
  }).then(function(){ loadChats(); });
}

// 載入好友與群組
function loadChats(){
  chats = [];
  Promise.all([
    fetch('/api/user/me').then(function(r){ return r.json(); }),
    fetch('/api/group/list').then(function(r){ return r.json(); })
  ]).then(function(vals){
    var u = vals[0], gs = vals[1];
    // 好友
    Object.keys(u.friendsMap).forEach(function(id){
      var info = u.friendsMap[id];
      chats.push({ id:id, type:'friend',
        name:info.nickname, avatarUrl:info.avatarUrl,
        isOnline:info.isOnline });
    });
    // 群組
    gs.forEach(function(g){
      chats.push({ id:g._id, type:'group',
        name:g.name, avatarUrl:g.avatarUrl||'/default-group.png' });
    });
    renderChatList();
  });
}
function renderChatList(){
  var list = document.getElementById('friend-list');
  list.innerHTML = '';
  chats.forEach(function(c){
    var el = document.createElement('div');
    el.className = 'friend';
    el.dataset.id = c.id + '|' + c.type;
    var dotHtml = '';
    if(c.type==='friend'){
      dotHtml = '<span class="status-dot" style="background:'+
        (c.isOnline?'#28a745':'#343a40')+'"></span>';
    }
    el.innerHTML = '<div class="status-wrapper"><img src="'+c.avatarUrl+
      '" width="36" height="36" class="rounded-circle">'+dotHtml+
      '</div><span>'+c.name+'</span>';
    el.onclick = function(){
      openChat(c.id, c.type, c.name);
    };
    list.appendChild(el);
  });
}

// 開啟聊天
function openChat(id, type, name){
  currentChat = { id:id, type:type };
  document.getElementById('chat-with').textContent =
    (type==='friend' ? '與 '+name+' 聊天中' : name);
  document.getElementById('message-log').innerHTML = '';
  document.getElementById('chat-form').classList.remove('d-none');
  socket.emit('load history',{ id:id, type:type });
}

// 圖片上傳
function triggerImageUpload(){
  document.getElementById('image-input').click();
}
function uploadImage(e){
  var file = e.target.files[0];
  if(!file || !currentChat) return;
  var form = new FormData();
  form.append('image', file);
  form.append('to', currentChat.id);
  form.append('type', currentChat.type);
  fetch('/api/upload-image',{ method:'POST', body:form })
    .then(function(r){ return r.json(); })
    .then(function(m){
      appendMessage(m, m.from===myId);
    });
}

// 接收 & 顯示訊息
socket.on('connect', function(){
  loadChats();

  socket.on('chat history', function(data){
    data.messages.forEach(function(m){
      appendMessage(m, m.from===myId);
    });
    document.getElementById('message-log').scrollTop = 1e9;
  });

  socket.on('private message', function(m){
    if(currentChat && currentChat.type==='friend' && m.from===currentChat.id){
      appendMessage(m, false);
      document.getElementById('message-log').scrollTop = 1e9;
    }
  });

  socket.on('group message', function(m){
    if(currentChat && currentChat.type==='group' && m.groupId===currentChat.id){
      appendMessage(m, false);
      document.getElementById('message-log').scrollTop = 1e9;
    }
  });

  socket.on('friend-online', function(evt){
    var sel = '[data-id="'+evt.id+'|friend"] .status-dot';
    var el = document.querySelector(sel);
    if(el) el.style.background = '#28a745';
  });
  socket.on('friend-offline', function(evt){
    var sel = '[data-id="'+evt.id+'|friend"] .status-dot';
    var el = document.querySelector(sel);
    if(el) el.style.background = '#343a40';
  });
});

// 發送文字
document.getElementById('chat-form').addEventListener('submit', function(e){
  e.preventDefault();
  var txt = document.getElementById('message-input').value.trim();
  if(!txt || !currentChat) return;
  if(currentChat.type==='friend'){
    socket.emit('private message',{ toUserId:currentChat.id, message:txt });
  } else {
    socket.emit('group message',{ to:currentChat.id, message:txt });
  }
  document.getElementById('message-input').value = '';
});

// 顯示訊息
function appendMessage(msg, isSelf){
  var box = document.getElementById('message-log');
  var div = document.createElement('div');
  div.className = 'message' + (isSelf ? ' self' : '');
  var content = '';
  if(msg.imageUrl){
    content = '<img src="'+msg.imageUrl+'" class="content-image">';
  } else {
    content = msg.message;
  }
  var inner = '<div style="display:flex;gap:.5rem;">'
    + '<img src="'+msg.avatarUrl+'" width="36" height="36" class="rounded-circle">'
    + '<div><div>'+msg.nickname
    + ' <span style="font-size:.75em;color:gray;">'
    + new Date(msg.timestamp).toLocaleTimeString()
    + '</span></div><div>'+content+'</div>'
    + (msg.read && msg.from===myId ? '<div class="read-indicator">✓ 已讀</div>' : '')
    + '</div></div>';
  div.innerHTML = inner;
  box.appendChild(div);
}

// 登出
function logout(){ location.href='/auth/logout'; }

// 取得自己資訊
fetch('/api/user/me').then(function(r){ return r.json(); })
.then(function(u){
  myId = u.id;
  myNickname = u.nickname;
  myUserCode = u.userCode;
  myAvatarUrl = u.avatarUrl;
  document.getElementById('my-name').textContent = myNickname;
  document.getElementById('my-code').textContent = myUserCode;
});
</script>
</body>
</html>
