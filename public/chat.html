<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>精美聊天室</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #f8f9fa; }
    .container { display: flex; height: 100%; }
    .sidebar { width: 260px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
    .sidebar h5 { margin: 1rem; }
    .tabs { display: flex; }
    .tabs button { flex: 1; border: none; background: #ececec; padding: 0.5rem; cursor: pointer; }
    .tabs button.active { background: #fff; font-weight: bold; }
    .list { flex: 1; overflow-y: auto; padding: 0 1rem; }
    .item { display: flex; align-items: center; padding: 0.5rem 0; cursor: pointer; }
    .item .status-wrapper { position: relative; }
    .item .status-dot { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; border: 2px solid #fff; border-radius: 50%; }
    .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
    .chat-header { background: #fff; padding: 1rem; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { flex: 1; padding: 1rem; overflow-y: auto; background: #e9ecef; }
    .chat-footer { background: #fff; padding: .5rem 1rem; display: flex; align-items: center; border-top: 1px solid #ddd; }
    .chat-footer input[type="file"] { display: none; }
    .message { display: flex; margin-bottom: 1rem; }
    .message.self { flex-direction: row-reverse; }
    .message .avatar { width: 40px; height: 40px; border-radius: 50%; margin: 0 0.5rem; }
    .message .bubble { background: #fff; padding: .5rem 1rem; border-radius: 1rem; position: relative; max-width: 70%; }
    .message .bubble img { max-width: 100%; border-radius: .5rem; }
    .message .bubble .time { font-size: .75rem; color: gray; position: absolute; bottom: -1.2rem; right: .5rem; }
    .message.self .bubble { background: #d0ebff; }
    .modal-backdrop.custom { background: rgba(0,0,0,0.5); position: absolute; top: 0; left:0; width:100%; height:100%; }
    .modal.custom { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); background: #fff; padding: 1rem; border-radius: .5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 300px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h5>聊天室</h5>
      <div class="tabs">
        <button id="tabFriends" class="active" onclick="showTab('friends')">好友</button>
        <button id="tabGroups" onclick="showTab('groups')">群組</button>
      </div>
      <div id="friendsList" class="list"></div>
      <div id="groupsList" class="list" style="display:none"></div>
      <button class="btn btn-primary m-3" onclick="openCreateGroup()">建立群組</button>
    </div>
    <div class="chat-area">
      <div class="chat-header">
        <div id="chatTitle">選擇一個對話</div>
        <div>
          <button onclick="openImageUpload()" class="btn btn-outline-secondary btn-sm">📷</button>
          <button onclick="logout()" class="btn btn-outline-danger btn-sm">登出</button>
        </div>
      </div>
      <div id="chatMessages" class="chat-messages"></div>
      <div class="chat-footer">
        <button class="btn btn-outline-secondary me-2" onclick="openImageUpload()">📎</button>
        <input type="text" id="chatInput" class="form-control me-2" placeholder="輸入訊息..." autocomplete="off">
        <button class="btn btn-primary" onclick="sendMessage()">送出</button>
        <input type="file" id="imageInput" accept="image/*" onchange="uploadImage(event)">
      </div>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop custom" style="display:none"></div>
  <div id="createGroupModal" class="modal custom" style="display:none">
    <h5>建立群組</h5>
    <input id="groupNameInput" class="form-control mb-2" placeholder="群組名稱">
    <div id="groupMembersList" style="max-height:150px; overflow-y:auto; margin-bottom:.5rem"></div>
    <button class="btn btn-success" onclick="createGroup()">建立</button>
    <button class="btn btn-secondary ms-2" onclick="closeModal()">取消</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let selfId, currentChatId, currentChatType;
    let friends={}, groups={};
    fetch('/api/user/me').then(r=>r.json()).then(u=>{
      selfId=u.id; friends=u.friendsMap; renderFriends(); loadGroups();
    });

    function showTab(tab){
      document.getElementById('friendsList').style.display = tab==='friends'?'block':'none';
      document.getElementById('groupsList').style.display = tab==='groups'?'block':'none';
      document.getElementById('tabFriends').classList.toggle('active', tab==='friends');
      document.getElementById('tabGroups').classList.toggle('active', tab==='groups');
    }
    function renderFriends(){
      const fL=document.getElementById('friendsList'); fL.innerHTML='';
      for(let id in friends){ let f=friends[id];
        const el=document.createElement('div'); el.className='item'; el.dataset.id=id;
        el.innerHTML=`<div class="status-wrapper"><img src="${f.avatarUrl}" width="40" height="40" class="rounded-circle"><span class="status-dot" style="background:${f.isOnline?'#28a745':'#343a40'}"></span></div><span>${f.nickname}</span>`;
        el.onclick=()=>openChat(id,'friend'); fL.appendChild(el);
      }
    }
    function loadGroups(){ fetch('/api/group/list').then(r=>r.json()).then(g=>{groups=g; renderGroups();}); }
    function renderGroups(){ const gL=document.getElementById('groupsList'); gL.innerHTML='';
      for(let gid in groups){ let g=groups[gid];
        const el=document.createElement('div'); el.className='item'; el.dataset.id=gid;
        el.innerHTML=`<div class="status-wrapper"><img src="${g.avatarUrl||'/default-group.png'}" width="40" height="40" class="rounded-circle"></div><span>${g.name}</span>`;
        el.onclick=()=>openChat(gid,'group'); gL.appendChild(el);
      }
    }
    function openChat(id,type){ currentChatId=id; currentChatType=type;
      document.getElementById('chatTitle').textContent = type==='friend'?friends[id].nickname:groups[id].name;
      document.getElementById('chatMessages').innerHTML='';
      socket.emit('load history',{id,type});
    }
    socket.on('chat history',data=>{const box=document.getElementById('chatMessages');
      data.messages.forEach(m=>appendMessage(m,m.from===selfId)); box.scrollTop=box.scrollHeight;
    });
    function sendMessage(){ const txt=document.getElementById('chatInput').value.trim(); if(!txt||!currentChatId) return;
      socket.emit(currentChatType==='friend'?'private message':'group message',{to:currentChatId, message:txt}); document.getElementById('chatInput').value='';
    }
    socket.on('private message',m=>{ if(currentChatType==='friend'&&m.from===currentChatId) appendMessage(m,false); });
    socket.on('group message',m=>{ if(currentChatType==='group'&&m.groupId===currentChatId) appendMessage(m,false); });

    function appendMessage(m,isSelf){ const box=document.getElementById('chatMessages'); const div=document.createElement('div'); div.className='message'+(isSelf?' self':'');
      let content = m.imageUrl?`<img src="${m.imageUrl}" />`:`<span>${m.message}</span>`;
      div.innerHTML=`<img src="${m.avatarUrl}" class="avatar"><div class="bubble">${content}<div class="time">${new Date(m.timestamp).toLocaleTimeString()}</div></div>`;
      box.appendChild(div); box.scrollTop=box.scrollHeight;
    }
    function openImageUpload(){ document.getElementById('imageInput').click(); }
    function uploadImage(e){ const file=e.target.files[0]; if(!file||!currentChatId) return;
      const form=new FormData(); form.append('image',file); form.append('to',currentChatId); form.append('type',currentChatType);
      fetch('/api/upload-image',{method:'POST',body:form}).then(r=>r.json()).then(m=>appendMessage(m,true));
    }
    // group modal
    function openCreateGroup(){document.getElementById('modalBackdrop').style.display='block'; document.getElementById('createGroupModal').style.display='block'; loadFriendsForGroup(); }
    function closeModal(){document.getElementById('modalBackdrop').style.display='none'; document.getElementById('createGroupModal').style.display='none';}
    function loadFriendsForGroup(){ const list=document.getElementById('groupMembersList'); list.innerHTML=''; for(let id in friends){
      const cb=document.createElement('input'); cb.type='checkbox'; cb.value=id; cb.id='cb'+id;
      list.appendChild(cb); list.appendChild(document.createTextNode(friends[id].nickname)); list.appendChild(document.createElement('br'));
    }}
    function createGroup(){ const name=document.getElementById('groupNameInput').value.trim(); const cbs=document.querySelectorAll('#groupMembersList input:checked'); const members=[selfId]; cbs.forEach(cb=>members.push(cb.value));
      fetch('/api/group/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,members})})
        .then(()=>{closeModal(); loadGroups();});
    }
    function logout(){ window.location.href='/logout'; }
  </script>
</body>
</html>
