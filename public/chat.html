<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <title>精美聊天室</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /*－－基礎布局－－*/
    html,body{height:100%;margin:0;font-family:'Segoe UI',sans-serif;}
    .app-container{display:flex;height:100vh;}
    .sidebar{width:280px;background:#f8f9fa;border-right:1px solid #dee2e6;display:flex;flex-direction:column;transition:transform .3s;}
    .sidebar h5{padding:1rem;margin:0;border-bottom:1px solid #dee2e6;}
    .friend-list{flex:1;overflow-y:auto;padding:.5rem 1rem;}
    .friend{display:flex;align-items:center;gap:.75rem;padding:.5rem;border-radius:.5rem;cursor:pointer;transition:background .2s;}
    .friend:hover{background:#e9ecef;}
    .status-wrapper{position:relative;}
    .status-dot{position:absolute;bottom:0;right:0;width:10px;height:10px;border-radius:50%;border:2px solid #fff;}
    .chat-area{flex:1;display:flex;flex-direction:column;position:relative;}
    .chat-header{padding:1rem;border-bottom:1px solid #dee2e6;background:#fff;font-weight:bold;display:flex;align-items:center;justify-content:space-between;}
    #sidebarToggle{display:none;background:none;border:none;font-size:1.5rem;cursor:pointer;margin-right:.5rem;}
    .chat-messages{flex:1;padding:1rem;overflow-y:auto;background:#f1f3f5;display:flex;flex-direction:column;gap:1rem;}
    .message{max-width:70%;padding:.75rem 1rem;border-radius:1rem;box-shadow:0 1px 4px rgba(0,0,0,.1);position:relative;background:#fff;}
    .message.self{align-self:flex-end;background:#d0ebff;}
    .bubble-content{margin-top:.5rem;word-wrap:break-word;}
    img.content-image{max-width:180px;max-height:180px;object-fit:contain;cursor:pointer;border-radius:4px;}
    .time{display:block;text-align:right;font-size:.75em;color:gray;margin-top:.25rem;}
    .read-indicator{font-size:.75em;color:green;margin-top:.25rem;}
    .chat-input{padding:1rem;border-top:1px solid #dee2e6;background:#fff;}
    /* 右鍵選單 */
    #msg-context-menu{display:none;position:absolute;background:#fff;border:1px solid #ccc;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,.15);z-index:1500;}
    #msg-context-menu div{padding:.5rem 1rem;cursor:pointer;}
    #msg-context-menu div:hover{background:#f1f3f5;}
    /* 頂部控制按鈕 */
    #top-controls{position:absolute;top:1rem;right:1rem;display:flex;gap:.75rem;}
    #top-controls button, #top-controls a{font-size:1em;}
    /* 新增好友 & 建群 區 */
    #addFriendSection,#createGroupSection{display:none;padding:0 1rem 1rem 1rem;}
    /* 遮罩 */
    #overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);z-index:1000;backdrop-filter:blur(4px);}
    #overlay.show{display:flex;align-items:center;justify-content:center;}
    /* 個人檔案 Modal */
    #profileModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);z-index:1100;align-items:center;justify-content:center;}
    #profileModal.show{display:flex;}
    #profileContent{background:#fff;border-radius:12px;padding:2rem;max-width:400px;width:90%;position:relative;transform:translateY(20px);animation:slideUp .4s ease forwards;}
    @keyframes slideUp{from{transform:translateY(20px)}to{transform:translateY(0)}}
    #profileContent h4{margin-bottom:1rem;}
    #closeProfile{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer;color:#666;}
    /* 圓形裁切＋滑動縮放 */
    #cropContainer{width:160px;height:160px;border-radius:50%;overflow:hidden;margin:0 auto 1rem;position:relative;border:2px solid #ddd;background:#f8f9fa;}
    #cropImage{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(1);transition:transform .2s;cursor:pointer;}
    .slider-container{display:flex;align-items:center;gap:.5rem;justify-content:center;margin-bottom:1rem;}
    /* 響應式 */
    @media(max-width:768px){
      #sidebarToggle{display:block;}
      .sidebar{position:fixed;top:0;left:0;height:100%;width:80%;max-width:280px;transform:translateX(-100%);z-index:500;}
      .sidebar.open{transform:translateX(0);}
      .chat-header{position:fixed;top:0;left:0;right:0;z-index:100;}
      .chat-messages{margin-top:56px;}
    }
  </style>
</head>
<body>

  <!-- 側邊欄遮罩 -->
  <div id="overlay"></div>

  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <h5>聊天清單</h5>
      <div class="friend-list" id="friend-list"></div>
      <div class="p-3">
        <button class="btn btn-success w-100 mb-2" onclick="toggleAddFriend()">新增好友</button>
        <div id="addFriendSection">
          <input type="text" id="friendIdInput" class="form-control mb-2" placeholder="輸入用戶ID">
          <button class="btn btn-primary w-100" onclick="submitAddFriend()">送出</button>
        </div>
        <button class="btn btn-warning w-100 mt-3 mb-2" onclick="toggleCreateGroup()">建立群組</button>
        <div id="createGroupSection">
          <input type="text" id="groupNameInput" class="form-control mb-2" placeholder="群組名稱">
          <div id="groupMembersCheckboxes" style="max-height:120px;overflow-y:auto;"></div>
          <button class="btn btn-primary w-100 mt-2" onclick="submitCreateGroup()">建立</button>
        </div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header">
        <button id="sidebarToggle" onclick="toggleSidebar()">☰</button>
        <span id="chat-with">請選擇聊天對象</span>
      </div>
      <div class="chat-messages" id="message-log"></div>
      <form id="chat-form" class="chat-input d-none">
        <div class="input-group">
          <button class="btn btn-outline-secondary" type="button" onclick="triggerImageUpload()">📷</button>
          <input type="file" id="image-input" accept="image/*" style="display:none" onchange="uploadImage(event)">
          <input type="text" id="message-input" class="form-control" placeholder="輸入訊息...">
          <button class="btn btn-primary" type="submit">傳送</button>
        </div>
      </form>

      <div id="top-controls">
        <button class="btn btn-outline-info btn-sm" onclick="toggleNotifMenu()">🔔</button>
        <button id="profileBtn" class="btn btn-outline-secondary btn-sm">👤</button>
        <a href="/auth/logout" class="btn btn-outline-danger btn-sm">登出</a>
      </div>
      <div id="notifMenu"></div>
    </div>
  </div>

  <!-- 右鍵選單 -->
  <div id="msg-context-menu"><div onclick="recallContextMessage()">收回</div></div>

  <!-- 個人檔案 Modal -->
  <div id="profileModal">
    <div id="profileContent">
      <button id="closeProfile">✕</button>
      <h4 class="text-center">個人檔案編輯</h4>
      <!-- 圓形裁切區 -->
      <div id="cropContainer">
        <img id="cropImage" src="/default-avatar.png" alt="大頭貼">
      </div>
      <!-- 縮放 slider -->
      <div class="slider-container">
        <label for="avatarScale">縮放：</label>
        <input type="range" id="avatarScale" min="0.5" max="2" step="0.01" value="1">
      </div>
      <!-- 選檔 button -->
      <div class="text-center mb-3">
        <label class="btn btn-outline-secondary">
          選擇新大頭貼
          <input type="file" id="avatarInput" accept="image/*">
        </label>
      </div>
      <!-- 暱稱輸入 -->
      <input type="text" id="nicknameInput" class="form-control mb-3" placeholder="輸入暱稱">
      <!-- 儲存按鈕 -->
      <button class="btn btn-primary w-100" onclick="submitProfile()">儲存設定</button>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox">
    <button id="lb-prev">&lt;</button>
    <img id="lb-img" src="">
    <button id="lb-next">&gt;</button>
    <button id="lb-close">✕</button>
  </div>

  <script>
    const socket = io();
    let myId, myNickname, myAvatarUrl;
    let chats = [], currentChat = null;
    let lbImages = [], lbIndex = 0, contextTargetMsgId = null;

    /* 側邊欄 */
    function toggleSidebar(){
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('overlay').classList.toggle('show');
    }
    function closeSidebar(){
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('overlay').classList.remove('show');
    }

    /* 載入使用者 & 清單 */
    function loadMe(){
      fetch('/api/user/me').then(r=>r.json()).then(u=>{
        myId=u.id; myNickname=u.nickname; myAvatarUrl=u.avatarUrl;
        // profile modal 預設
        document.getElementById('cropImage').src = u.avatarUrl;
        document.getElementById('nicknameInput').value = u.nickname;
        // 載清單
        loadChats();
      });
    }

    /* 通知 */
    function toggleNotifMenu(){
      const m = document.getElementById('notifMenu');
      m.innerHTML=''; fetch('/api/user/friend-requests').then(r=>r.json()).then(reqs=>{
        if(!reqs.length) m.innerHTML='<div class="p-2">沒有好友邀請。</div>';
        else reqs.forEach(rq=>{
          const d=document.createElement('div'); d.className='p-2 border-bottom';
          d.innerHTML=`
            <img src="${rq.avatarUrl}" width="30" height="30" class="rounded-circle"> 
            ${rq.nickname}
            <button onclick="respondFriend('${rq._id}',true)" class="btn btn-sm btn-success ms-2">接受</button>
            <button onclick="respondFriend('${rq._id}',false)" class="btn btn-sm btn-danger ms-1">拒絕</button>`;
          m.appendChild(d);
        });
      });
      m.style.display = m.style.display==='block'?'none':'block';
    }
    function respondFriend(id,ok){
      fetch('/api/user/respond-friend-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({requesterId:id,accept:ok})})
        .then(_=>{ toggleNotifMenu(); loadChats(); });
    }

    /* 新增好友 */
    function toggleAddFriend(){
      const s=document.getElementById('addFriendSection');
      s.style.display= s.style.display==='block'?'none':'block';
    }
    function submitAddFriend(){
      const code=document.getElementById('friendIdInput').value.trim();
      if(!code) return alert('請輸入用戶ID');
      fetch('/api/user/send-friend-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})})
        .then(r=>r.ok?alert('✅ 邀請已送出'):r.json().then(d=>alert('❌ '+d.message)));
    }

    /* 建立群組 */
    function toggleCreateGroup(){
      const s=document.getElementById('createGroupSection');
      if(s.style.display!=='block'){ populateGroupMembers(); s.style.display='block'; }
      else s.style.display='none';
    }
    function populateGroupMembers(){
      fetch('/api/user/me').then(r=>r.json()).then(u=>{
        const cbx=document.getElementById('groupMembersCheckboxes');
        cbx.innerHTML='';
        Object.entries(u.friendsMap).forEach(([id,info])=>{
          cbx.insertAdjacentHTML('beforeend',`
            <div><input type="checkbox" id="gm_${id}" value="${id}">
            <label for="gm_${id}">${info.nickname}</label></div>`);
        });
      });
    }
    function submitCreateGroup(){
      const name=document.getElementById('groupNameInput').value.trim();
      if(!name) return alert('請輸入群組名稱');
      const members=[myId];
      document.querySelectorAll('#groupMembersCheckboxes input:checked').forEach(i=>members.push(i.value));
      fetch('/api/group/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,members})})
        .then(_=>{ loadChats(); toggleCreateGroup(); });
    }

    /* 載清單 */
    function loadChats(){
      chats=[]; lbImages=[];
      Promise.all([ fetch('/api/user/me').then(r=>r.json()), fetch('/api/group/list').then(r=>r.json()) ])
        .then(([u,gs])=>{
          Object.entries(u.friendsMap).forEach(([id,info])=>{
            chats.push({id,type:'friend',name:info.nickname,avatarUrl:info.avatarUrl,isOnline:info.isOnline});
          });
          gs.forEach(g=>{
            chats.push({id:g._id,type:'group',name:g.name,avatarUrl:g.avatarUrl||'/default-avatar.png'});
          });
          renderChatList();
        });
    }
    function renderChatList(){
      const uniq={}; chats=chats.filter(c=>{ const k=c.id+'|'+c.type; if(uniq[k])return false; uniq[k]=1; return true; });
      const list=document.getElementById('friend-list'); list.innerHTML='';
      chats.forEach(c=>{
        const el=document.createElement('div'); el.className='friend'; el.dataset.id=c.id+'|'+c.type;
        const dot=c.type==='friend'?`<span class="status-dot" style="background:${c.isOnline?'#28a745':'#343a40'}"></span>`:'';
        el.innerHTML=`
          <div class="status-wrapper">
            <img src="${c.avatarUrl}" width="36" height="36" class="rounded-circle">${dot}
          </div><span>${c.name}</span>`;
        el.onclick=()=>openChat(c.id,c.type,c.name);
        list.appendChild(el);
      });
    }

    /* 打開聊天室 */
    function openChat(id,type,name){
      currentChat={id,type};
      document.getElementById('chat-with').textContent=type==='friend'?`與 ${name} 聊天中`:name;
      document.getElementById('message-log').innerHTML='';
      document.getElementById('chat-form').classList.remove('d-none');
      socket.emit('load history',{id,type});
    }

    /* 發訊息 */
    document.getElementById('chat-form').addEventListener('submit',e=>{
      e.preventDefault();
      const txt=document.getElementById('message-input').value.trim();
      if(!txt||!currentChat) return;
      const now=new Date();
      if(currentChat.type==='friend'){
        socket.emit('private message',{toUserId:currentChat.id,message:txt});
        appendMessage({id:null,from:myId,to:currentChat.id,message:txt,imageUrl:null,timestamp:now,read:false,recalled:false,avatarUrl:myAvatarUrl,nickname:myNickname},true);
      } else {
        socket.emit('group message',{to:currentChat.id,message:txt});
        appendMessage({id:null,from:myId,groupId:currentChat.id,message:txt,imageUrl:null,timestamp:now,read:false,recalled:false,avatarUrl:myAvatarUrl,nickname:myNickname},true);
      }
      document.getElementById('message-input').value='';
    });

    /* 圖片上傳 */
    function triggerImageUpload(){ document.getElementById('image-input').click(); }
    function uploadImage(e){
      const f=e.target.files[0]; if(!f||!currentChat) return;
      const form=new FormData(); form.append('image',f); form.append('to',currentChat.id); form.append('type',currentChat.type);
      fetch('/api/upload-image',{method:'POST',body:form}).then(r=>r.json()).then(m=>appendMessage(m,m.from===myId));
    }

    /* 顯示訊息 */
    function appendMessage(msg,isSelf){
      const box=document.getElementById('message-log');
      const div=document.createElement('div'); div.className='message'+(isSelf?' self':'');
      if(msg.id)div.dataset.id=msg.id;
      let content;
      if(msg.recalled) content='<em style="color:gray;">此則訊息已被收回</em>';
      else if(msg.imageUrl) content=`<img src="${msg.imageUrl}" class="content-image">`;
      else content=msg.message;
      div.innerHTML=`
        <div style="display:flex;gap:.5rem;">
          <img src="${msg.avatarUrl}" width="36" height="36" class="rounded-circle">
          <div>
            <strong>${msg.nickname}</strong>
            <div class="bubble-content">${content}</div>
            <span class="time">${new Date(msg.timestamp).toLocaleTimeString('zh-TW')}</span>
            ${msg.read&&isSelf?'<div class="read-indicator">✓ 已讀</div>':''}
          </div>
        </div>`;
      if(isSelf&&!msg.recalled&&msg.id){
        div.addEventListener('contextmenu',e=>{
          e.preventDefault();
          contextTargetMsgId=msg.id;
          const mnu=document.getElementById('msg-context-menu');
          mnu.style.top=e.pageY+'px'; mnu.style.left=e.pageX+'px'; mnu.style.display='block';
        });
      }
      box.appendChild(div); box.scrollTop=box.scrollHeight;
      if(msg.imageUrl&&!msg.recalled){
        lbImages.push(msg.imageUrl);
        setTimeout(()=>{
          const imgs=document.querySelectorAll('#message-log img.content-image');
          const imgEl=imgs[imgs.length-1], idx=lbImages.length-1;
          imgEl.onclick=()=>openLightbox(idx);
        },0);
      }
    }
    document.addEventListener('click',e=>{
      const mnu=document.getElementById('msg-context-menu');
      if(!mnu.contains(e.target)) mnu.style.display='none';
    });
    function recallContextMessage(){
      if(!contextTargetMsgId)return;
      fetch('/api/message/recall',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messageId:contextTargetMsgId})})
        .then(r=>r.ok&&(()=>{
          const el=document.querySelector(`.message[data-id="${contextTargetMsgId}"] .bubble-content`);
          if(el)el.innerHTML='<em style="color:gray;">此則訊息已被收回</em>';
        })());
      document.getElementById('msg-context-menu').style.display='none';
      contextTargetMsgId=null;
    }

    /* Lightbox */
    function openLightbox(i){
      lbIndex=i; document.getElementById('lb-img').src=lbImages[i]; document.getElementById('lightbox').style.display='flex';
    }
    document.getElementById('lb-close').onclick=()=>document.getElementById('lightbox').style.display='none';
    document.getElementById('lb-prev').onclick=()=>{lbIndex=(lbIndex-1+lbImages.length)%lbImages.length;document.getElementById('lb-img').src=lbImages[lbIndex];};
    document.getElementById('lb-next').onclick=()=>{lbIndex=(lbIndex+1)%lbImages.length;document.getElementById('lb-img').src=lbImages[lbIndex];};
    document.getElementById('lightbox').onclick=e=>{if(e.target.id==='lightbox')document.getElementById('lightbox').style.display='none';};

    /* 個人檔案 Modal 相關 */
    document.getElementById('profileBtn').onclick = ()=>{
      document.getElementById('profileModal').classList.add('show');
    };
    document.getElementById('closeProfile').onclick = ()=>{
      document.getElementById('profileModal').classList.remove('show');
    };
    // 縮放頭像
    document.getElementById('avatarScale').addEventListener('input',e=>{
      document.getElementById('cropImage').style.transform =
        `translate(-50%,-50%) scale(${e.target.value})`;
    });
    // 預覽新檔
    document.getElementById('avatarInput').addEventListener('change',e=>{
      const f=e.target.files[0];
      if(!f)return;
      document.getElementById('cropImage').src = URL.createObjectURL(f);
      document.getElementById('avatarScale').value = 1;
      document.getElementById('cropImage').style.transform = 'translate(-50%,-50%) scale(1)';
    });
    // 提交編輯
    function submitProfile(){
      const form=new FormData();
      const nick=document.getElementById('nicknameInput').value.trim();
      if(nick) form.append('nickname',nick);
      const f=document.getElementById('avatarInput').files[0];
      if(f) form.append('avatar',f);
      fetch('/api/user/update-profile',{method:'POST',body:form})
        .then(r=>r.json()).then(res=>{
          if(res.message){
            alert('更新成功');
            document.getElementById('profileModal').classList.remove('show');
            loadMe();
          }
        });
    }

    /* Socket 事件 */
    socket.on('connect',()=>{
      socket.on('friend-online',e=>{
        const d=document.querySelector(`[data-id="${e.id}|friend"] .status-dot`);
        if(d)d.style.background='#28a745';
      });
      socket.on('friend-offline',e=>{
        const d=document.querySelector(`[data-id="${e.id}|friend"] .status-dot`);
        if(d)d.style.background='#343a40';
      });
      socket.on('new-friend',f=>{
        if(!chats.find(c=>c.id===f.id&&c.type==='friend')){
          chats.push({id:f.id,type:'friend',name:f.nickname,avatarUrl:f.avatarUrl,isOnline:f.isOnline});
          renderChatList();
        }
      });
      socket.on('chat history',data=>{
        data.messages.forEach(m=>appendMessage(m,m.from===myId));
      });
      socket.on('private message',m=>{
        if(currentChat?.type==='friend'&&m.from===currentChat.id) appendMessage(m,false);
      });
      socket.on('group message',m=>{
        if(currentChat?.type==='group'&&m.groupId===currentChat.id) appendMessage(m,false);
      });
      socket.on('message recalled',d=>{
        const el=document.querySelector(`.message[data-id="${d.messageId}"] .bubble-content`);
        if(el) el.innerHTML='<em style="color:gray;">此則訊息已被收回</em>';
      });
    });

    window.onload = ()=>{ loadMe(); };
  </script>
</body>
</html>
