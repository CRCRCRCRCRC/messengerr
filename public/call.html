<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>VerbaRealmâ€”Call</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>body{margin:0;display:flex;flex-direction:column;height:100vh;}
    #remoteAudio,#localAudio{display:none;}
    #hangup{position:absolute;top:1rem;right:1rem;}
  </style>
</head>
<body>
  <button id="hangup">ğŸ“ æ›æ–·</button>
  <audio id="localAudio" autoplay muted></audio>
  <audio id="remoteAudio" autoplay></audio>

<script>
  const socket = io();
  const roomId = location.pathname.split('/').pop();
  let pc = null, localStream = null;
  console.log(`é€šè©±æˆ¿é–“ ID: ${roomId}`);

  // Join call room
  socket.emit('join-call',{ roomId });
  console.log('å·²ç™¼é€ join-call äº‹ä»¶');

  // Handle hangup
  document.getElementById('hangup').onclick = () => {
    console.log('æ›æ–·æŒ‰éˆ•é»æ“Š');
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      console.log('æœ¬åœ°åª’é«”è»Œé“å·²åœæ­¢');
    }
    if(pc){
      pc.close();
      pc = null;
      console.log('RTCPeerConnection å·²é—œé–‰');
    }
    window.close();
  };

  // When both sides join,ç¬¬ä¸€å€‹åŠ å…¥å¾Œæœƒæ”¶åˆ°å°æ–¹å…¥å®¤äº‹ä»¶
  socket.on('offer', async ({ from, offer }) => {
    console.log('æ”¶åˆ° offer äº‹ä»¶ï¼Œä¾†è‡ª:', from, 'Offer:', offer);
    if (!pc) {
        console.log('æ”¶åˆ° offer æ™‚ pc æœªå»ºç«‹ï¼Œå‘¼å« startPeer');
        await startPeer();
    }
    try {
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      console.log('é ç«¯æè¿° (offer) è¨­å®šæˆåŠŸ');
      const answer = await pc.createAnswer();
      console.log('Answer å»ºç«‹æˆåŠŸ:', answer);
      await pc.setLocalDescription(answer);
      console.log('æœ¬åœ°æè¿° (answer) è¨­å®šæˆåŠŸ');
      socket.emit('answer',{ roomId, answer });
      console.log('å·²ç™¼é€ answer äº‹ä»¶');
    } catch (err) {
      console.error('è™•ç† offer æˆ–å»ºç«‹ answer æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }
  });

  // å‘¼å«è€…æ”¶åˆ° answer
  socket.on('answer', async ({ answer }) => {
    console.log('æ”¶åˆ° answer äº‹ä»¶:', answer);
    try {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
      console.log('é ç«¯æè¿° (answer) è¨­å®šæˆåŠŸ');
    } catch (err) {
      console.error('è¨­å®šé ç«¯æè¿° (answer) æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }
  });

  // ICE candidate äº¤æ›
  socket.on('ice-candidate', async ({ candidate }) => {
    console.log('æ”¶åˆ° ice-candidate äº‹ä»¶:', candidate);
    try {
      if (candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
        console.log('ICE candidate æ–°å¢æˆåŠŸ');
      } else {
        console.log('æ”¶åˆ°ç©ºçš„ ICE candidate');
      }
    } catch(err){
      console.error('æ–°å¢ ICE candidate æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
    }
  });

  // éƒ½é€²æˆ¿å¾Œï¼Œå¦‚æœæˆ‘æ˜¯å‘¼å«è€…ï¼Œå°±å…ˆç™¼ offer
  socket.on('connect', async () => {
    console.log('Socket å·²é€£æ¥ï¼ŒID:', socket.id);
    // delay ä¸€ä¸‹ç­‰å°æ–¹ä¹Ÿ join
    setTimeout(async ()=> {
      console.log('setTimeout è§¸ç™¼ï¼Œæº–å‚™ startPeer (å¦‚æœæˆ‘æ˜¯å‘¼å«è€…)');
      if (!pc) { // ç¢ºä¿ pc åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œæˆ–è€…æ ¹æ“šé‚è¼¯åˆ¤æ–·æ˜¯å¦ç‚ºå‘¼å«æ–¹ä¾†æ±ºå®šæ˜¯å¦ä¸»å‹• startPeer
          await startPeer();
      }
      // onnegotiationneeded é€šå¸¸ç”± pc å…§éƒ¨ç‹€æ…‹è®ŠåŒ–è§¸ç™¼ (ä¾‹å¦‚ addTrack)
      // å¦‚æœä½ æ˜¯å‘¼å«æ–¹ï¼Œä¸”å¸Œæœ›åœ¨ startPeer å®Œæˆå¾Œä¸»å‹•ç™¼èµ· offerï¼Œå¯ä»¥é€™æ¨£åš
      // ä½†æ›´å¥½çš„åšæ³•æ˜¯ä¾è³´ onnegotiationneeded äº‹ä»¶
    }, 500);
  });

  // å…¬å…±çš„ï¼šå»ºç«‹ RTCPeerConnection and æœ¬åœ° stream
  async function startPeer(){
    if(pc) {
      console.log('startPeer è¢«å‘¼å«ï¼Œä½† pc å·²å­˜åœ¨ï¼Œè¿”å›ã€‚');
      return;
    }
    console.log('startPeer å‡½å¼é–‹å§‹åŸ·è¡Œ');
    pc = new RTCPeerConnection({ 
      iceServers:[{urls:'stun:stun.l.google.com:19302'}] 
    });
    console.log('RTCPeerConnection å·²å»ºç«‹');

    pc.onicecandidate = e => {
      if(e.candidate){
        console.log('ç”¢ç”Ÿæ–°çš„ ICE candidate:', e.candidate);
        socket.emit('ice-candidate',{ roomId, candidate:e.candidate });
      } else {
        console.log('æ‰€æœ‰ ICE candidates éƒ½å·²æ”¶é›†å®Œç•¢ã€‚');
      }
    };

    pc.ontrack = e =>{
      console.log('æ”¶åˆ°é ç«¯è»Œé“ (ontrack äº‹ä»¶):', e);
      if (e.streams && e.streams[0]) {
        console.log('é ç«¯ä¸²æµ:', e.streams[0]);
        document.getElementById('remoteAudio').srcObject = e.streams[0];
        console.log('é ç«¯éŸ³è¨Šä¸²æµå·²è¨­å®šåˆ° remoteAudio å…ƒç´ ');
         e.streams[0].getTracks().forEach(track => {
            console.log('é ç«¯è»Œé“è©³æƒ…:', track.kind, track.label, track.id, track.readyState);
        });
      } else {
        console.warn('ontrack äº‹ä»¶è§¸ç™¼ï¼Œä½† e.streams[0] ä¸å­˜åœ¨');
      }
    };

    pc.oniceconnectionstatechange = () => {
        if(pc) console.log('ICE é€£ç·šç‹€æ…‹æ”¹è®Š:', pc.iceConnectionState);
    };
    
    pc.onsignalingstatechange = () => {
        if(pc) console.log('Signaling state changed:', pc.signalingState);
    };
    
    pc.onnegotiationneeded = async () => {
        console.log('onnegotiationneeded äº‹ä»¶è§¸ç™¼');
        try {
            console.log('æº–å‚™å»ºç«‹ offer');
            const offer = await pc.createOffer();
            console.log('Offer å»ºç«‹æˆåŠŸ:', offer);
            await pc.setLocalDescription(offer);
            console.log('æœ¬åœ°æè¿° (offer) è¨­å®šæˆåŠŸ');
            socket.emit('offer',{ roomId, offer });
            console.log('å·²é€é onnegotiationneeded ç™¼é€ offer äº‹ä»¶');
        } catch (err) {
            console.error('onnegotiationneeded è™•ç†æ™‚ç™¼ç”ŸéŒ¯èª¤:', err);
        }
    };

    try {
      console.log('æº–å‚™ç²å–æœ¬åœ°åª’é«”ä¸²æµ (getUserMedia)');
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
      console.log('æœ¬åœ°åª’é«”ä¸²æµç²å–æˆåŠŸ:', localStream);
      localStream.getTracks().forEach(track => {
        console.log('å°‡æœ¬åœ°è»Œé“åŠ å…¥åˆ° PeerConnection:', track);
        pc.addTrack(track, localStream);
      });
      document.getElementById('localAudio').srcObject = localStream;
      console.log('æœ¬åœ°éŸ³è¨Šä¸²æµå·²è¨­å®šåˆ° localAudio å…ƒç´ ');
    } catch (err) {
      console.error('ç²å–æœ¬åœ°åª’é«”ä¸²æµ (getUserMedia) å¤±æ•—:', err);
    }
  }

  // åˆå§‹å‘¼å« (å¯ä»¥è€ƒæ…®ç”±æŸå€‹æ˜ç¢ºçš„ã€Œé–‹å§‹é€šè©±ã€æŒ‰éˆ•è§¸ç™¼ï¼Œè€Œä¸æ˜¯ socket connect)
  // å¦‚æœé€™å€‹é é¢æ˜¯å°ˆé–€çµ¦é€šè©±çš„ï¼Œé‚£éº¼ä¸€è¼‰å…¥å°±å˜—è©¦å»ºç«‹ peer connection æ˜¯åˆç†çš„
  // ä½†éœ€è¦å”èª¿èª°æ˜¯ offerer å’Œ answerer
  // å¦‚æœæ˜¯å‘¼å«æ–¹æ‰“é–‹æ­¤é é¢ï¼Œå®ƒæ‡‰è©²ç™¼èµ· offer
  // å¦‚æœæ˜¯è¢«å«æ–¹æ‰“é–‹æ­¤é é¢ï¼Œå®ƒæ‡‰è©²ç­‰å¾… offer
  // ç›®å‰çš„é‚è¼¯æ˜¯: `setTimeout` å…§éƒ¨çš„ `startPeer` æœƒè®“ç¬¬ä¸€å€‹é€²æˆ¿çš„ (å¯èƒ½æ˜¯å‘¼å«è€…) æº–å‚™å¥½ç™¼ offer (é€é onnegotiationneeded)
  // è€Œè¢«å«æ–¹æœƒåœ¨æ”¶åˆ° `offer` äº‹ä»¶å¾Œæ‰å‘¼å« `startPeer`
  // ç‚ºäº†é¿å…é›™æ–¹éƒ½ä¸»å‹•å‘¼å« startPeer() ä¸¦è§¸ç™¼ onnegotiationneeded, 
  // socket.on('connect') å…§çš„ startPeer() æ‡‰è©²åªåœ¨åˆ¤æ–·è‡ªå·±æ˜¯å‘¼å«è€…æ™‚åŸ·è¡Œ
  // æˆ–è€…ï¼Œç§»é™¤ socket.on('connect') ä¸­çš„ startPeer, æ”¹ç‚ºç”±ä¸€å€‹åˆå§‹ä¿¡ä»¤ (ä¾‹å¦‚ï¼Œèª°æ˜¯å‘¼å«è€…) ä¾†æ±ºå®šèª°å…ˆèª¿ç”¨ startPeer å’Œè§¸ç™¼ offer

</script>
</body>
</html>
