<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>VerbaRealmâ€”Call</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>body{margin:0;display:flex;flex-direction:column;height:100vh;}
    #remoteAudio,#localAudio{display:none;}
    #hangup{position:absolute;top:1rem;right:1rem;}
  </style>
</head>
<body>
  <button id="hangup">ðŸ“ž æŽ›æ–·</button>
  <audio id="localAudio" autoplay muted></audio>
  <audio id="remoteAudio" autoplay></audio>

<script>
  const socket = io();
  const roomId = location.pathname.split('/').pop();
  let pc = null, localStream = null;

  // Join call room
  socket.emit('join-call',{ roomId });

  // Handle hangup
  document.getElementById('hangup').onclick = () => {
    if(pc){ pc.close(); pc = null; }
    window.close();
  };

  // When both sides join,ç¬¬ä¸€å€‹åŠ å…¥å¾Œæœƒæ”¶åˆ°å°æ–¹å…¥å®¤äº‹ä»¶
  socket.on('offer', async ({ from, offer }) => {
    // è¢«å«æ–¹ï¼ç¬¬äºŒå€‹åŠ å…¥ï¼šå»ºç«‹ Peerï¼ŒæŽ¥ offerï¼Œå›ž answer
    await startPeer();
    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('answer',{ roomId, answer });
  });

  // å‘¼å«è€…æ”¶åˆ° answer
  socket.on('answer', async ({ answer }) => {
    await pc.setRemoteDescription(answer);
  });

  // ICE candidate äº¤æ›
  socket.on('ice-candidate', async ({ candidate }) => {
    try { await pc.addIceCandidate(candidate); }
    catch(e){ console.error(e); }
  });

  // éƒ½é€²æˆ¿å¾Œï¼Œå¦‚æžœæˆ‘æ˜¯å‘¼å«è€…ï¼Œå°±å…ˆç™¼ offer
  socket.on('connect', async () => {
    // delay ä¸€ä¸‹ç­‰å°æ–¹ä¹Ÿ join
    setTimeout(async ()=> {
      // å»º Peer ä¸¦æ‹¿ mic
      await startPeer();
      // only for the one whoå…ˆ click call (å‘¼å«è€…)
      pc.onnegotiationneeded = async ()=>{
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit('offer',{ roomId, offer });
      };
    }, 500);
  });

  // å…¬å…±çš„ï¼šå»ºç«‹ RTCPeerConnection and æœ¬åœ° stream
  async function startPeer(){
    if(pc) return;
    pc = new RTCPeerConnection({ 
      iceServers:[{urls:'stun:stun.l.google.com:19302'}] 
    });
    pc.onicecandidate = e => {
      if(e.candidate){
        socket.emit('ice-candidate',{ roomId, candidate:e.candidate });
      }
    };
    pc.ontrack = e =>{
      document.getElementById('remoteAudio').srcObject = e.streams[0];
    };
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    document.getElementById('localAudio').srcObject = localStream;
  }
</script>
</body>
</html>
